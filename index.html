<html>
  <head>


    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
    var start = async function() {

      async function fetchAndParseCSVToArray(url) {
          try {
              // Fetch the CSV data
              const response = await fetch(url);
              const data = await response.text();

              // Parse the CSV data
              const lines = data.split('\n');

              // Remove empty lines (optional)
              return lines.filter(line => line.trim());

          } catch (error) {
              console.error('Error fetching or parsing CSV:', error);
              return []; // Return an empty array in case of an error
          }
      }

      var rows = await fetchAndParseCSVToArray('https://owocki.github.io/data.csv');


      google.charts.load('current', {'packages':['sankey']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
      var colors = ['#a6cee3', '#b2df8a', '#fb9a99', '#fdbf6f',
                    '#cab2d6', '#ffff99', '#1f78b4', '#33a02c'];

      var options = {
        height: 500, //window.innerHeight * 1.1,
        width: window.innerWidth- 50,
        sankey: {
          node: {
            colors: colors
          },
          link: {
            colorMode: 'gradient',
            colors: colors
          }
        }
      };


        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        var _scale = function(x){
          return x;
        }

        if(urlParams.get('scaledown')){
          var _scale = function(x){
            return Math.pow(x, 1/3);
            //return (Math.sqrt(x));
            //return Math.sqrt(Math.sqrt(x));
          }
        } else {

        }

        var data = new google.visualization.DataTable();
        data.addColumn('string', 'From');
        data.addColumn('string', 'To');
        data.addColumn('number', 'Weight');

        var new_rows = []
        for(var i=0; i<rows.length; i++){
          if(rows[i][0] && rows[i][1] && rows[i][2]){
            new_rows.push([rows[i][0],rows[i][1],_scale(rows[i][2])]);
          }
        }

        data.addRows(new_rows);

        // Instantiates and draws our chart, passing in some options.
        var chart = new google.visualization.Sankey(document.getElementById('sankey_basic'));
        chart.draw(data, options);
      }
    };;
    start();
    </script>
  </head>
  <body>
    <h1> Public Goods Funding Flowing in Ethereum: 2023</h1>
    <div>
        <text style="color:red;">WARNING: THIS IS AN ALPHA VERSION OF THIS SITE AND THE DATA IS NOT 100% CONFIRMED YET.<BR></text>
        mode: <a href="https://owocki.github.io/">Regular (but Whale Dominated) üê≥</a> | <a href="https://owocki.github.io/?scaledown=1">Sqrt Amounts (Whales Scaled Down) üêü</a>
    </div>
    <div>
      <h2 style="width:33%; display: inline-block;">Funding Source</h2>
      <h2 style="width:33%; display: inline-block; text-align: center;">dApp/Org</h2>
      <h2 style="width:33%; display: inline-block; text-align: right;">Mechanism</h2>
    </div>
    <div id="sankey_basic" style="height: 500px; width: 300px;"></div>
    <div>
        Inspired by convos at Zuzalu + <a href="https://twitter.com/owocki/status/1721890700206465273?s=46&t=X0oQ26a3ezptVAZLp1QFaw">this tweet thread</a>. The data presented here is a best guess good faith representation of the ecosystem.  If you have issues, please track in github or 
        <a href="https://github.com/owocki/owocki.github.io"> fork me</a>.
    </div>
  </body>
</html>
