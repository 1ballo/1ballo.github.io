<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      var baseUrl = function(){
        var baseurl = window.location.origin+window.location.pathname;
        return baseurl;        
      }
      var urlParams = function(){
        const queryString = window.location.search;
        return  new URLSearchParams(queryString);
      }
              
    var start = async function() {
      async function fetchAndParseCSVToArray(url) {
          try {
              // Fetch the CSV data
              const response = await fetch(url);
              const data = await response.text();
              // Parse the CSV data
              const lines = data.split('\n');
              // Remove empty lines (optional)
              return lines.filter(line => line.trim());
          } catch (error) {
              console.error('Error fetching or parsing CSV:', error);
              return []; // Return an empty array in case of an error
          }
      }
      var rows = await fetchAndParseCSVToArray('https://owocki.github.io/data.csv');
      google.charts.load('current', {'packages':['sankey']});
      google.charts.setOnLoadCallback(drawChart);
      function drawChart() {
      var colors = ['#a6cee3', '#b2df8a', '#fb9a99', '#fdbf6f',
                    '#cab2d6', '#ffff99', '#1f78b4', '#33a02c'];
      var options = {
        height: window.innerHeight * 1.1,
        width: window.innerWidth- 50,
        sankey: {
          node: {
            colors: colors
          },
          link: {
            colorMode: 'gradient',
            colors: colors
          }
        }
      };
      document.getElementById('sankey_basic').style=height = window.innerHeight;
      document.getElementById('sankey_basic').style=width = window.innerWidth;
        var _scale = function(x){
          return x;
        }
        if(urlParams().get('scaledown')){
          var _scale = function(x){
            return Math.pow(x, 1/3);
            //return (Math.sqrt(x));
            //return Math.sqrt(Math.sqrt(x));
          }
          document.getElementById("scaledown_off").style.fontWeight='bold';
        } else {
          document.getElementById("scaledown_on").style.fontWeight='bold';
        }
        if(urlParams().get('showprojects')){
            document.getElementById("title").style.display='none';
            document.getElementById("title_projects").style.display='block';
            document.getElementById("showprojects_off").style.fontWeight='bold';
        } else {
            document.getElementById("showprojects_on").style.fontWeight='bold';
        }
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'From');
        data.addColumn('string', 'To');
        data.addColumn('number', 'Weight');
        var new_rows = []
        for(var i=1; i<rows.length; i++){
          var split_row = rows[i].split(',');
          if(split_row[0] && split_row[1] && split_row[2]){
            var include = split_row[3] != 'column_3' || urlParams().get('showprojects');
            console.log(split_row[4]);
            if(split_row[4] && split_row[4] == 'Include?  This is mostly for DAO ecosystems not ETH public goods'){
                include = false;
            }
            if (include){
              new_rows.push([split_row[0],split_row[1],_scale(Number(split_row[2]))]);
            }
          }
        }
        data.addRows(new_rows);
        // Instantiates and draws our chart, passing in some options.
        var chart = new google.visualization.Sankey(document.getElementById('sankey_basic'));
        chart.draw(data, options);
      }
    };;
    start();
    </script>
  </head>
  <body>
    <h1> Public Goods Funding Flowing in Ethereum: 2023</h1>
    <div>
        mode: 
        <br>-<a id=scaledown_on href="#" onclick="document.location=baseUrl() + '?scaledown=&showprojects='+urlParams().get('showprojects');">Regular (but Whale Dominated) üê≥</a> 
        | <a id=scaledown_off href="#" onclick="document.location=baseUrl() + '?scaledown=1&showprojects='+urlParams().get('showprojects');">Logarthmic (Whales Scaled Down) üêü</a>
        <br>-<a id=showprojects_on href="#" onclick="document.location=baseUrl() + '?scaledown='+urlParams().get('scaledown')+'&showprojects='">NO Projects</a> 
        | <a id=showprojects_off href="#" onclick="document.location=baseUrl() + '?scaledown='+urlParams().get('scaledown')+'&showprojects=1'">Show Projects</a>
    </div>
    <div id=title>
      <h2 style="width:49%; display: inline-block;">Funding Source</h2>
      <h2 style="width:50%; display: inline-block; text-align: right;">dApp/Org/Mechanism</h2>
    </div>
    <div id=title_projects style="display:none;">
      <h2 style="width:33%; display: inline-block;">Funding Source</h2>
      <h2 style="width:33%; display: inline-block; text-align: center;">dApp/Org/Mechanism</h2>
      <h2 style="width:33%; display: inline-block; text-align: right;">Projects</h2>
    </div>
    <div id="sankey_basic"></div>
    <div>
        Inspired by convos at Zuzalu + <a href="https://twitter.com/owocki/status/1721890700206465273?s=46&t=X0oQ26a3ezptVAZLp1QFaw">this tweet thread</a>. 
        <br>
        <br>
        The data presented here is a best guess good faith representation of the ecosystem.  If you have issues, please track in github or 
        <a href="https://github.com/owocki/owocki.github.io"> fork me</a>.
        <br>
        <br>
        Get the data <a href="https://docs.google.com/spreadsheets/d/1IOkWvVtDnuSIBXAtEDgN01aE_ivH8gNapW7eHnW3fNc/edit#gid=34074864">here</a>
    </div>
  </body>
</html>
